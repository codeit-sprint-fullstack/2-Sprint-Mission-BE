<!DOCTYPE html>

<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=3, user-scalable=yes"/>

<codeprint id="docuK-style">
<div class="docuK rendered"><div class="sec" id="docuK-log"></div></div>

<!-- From kipid.tistory CDN -->
<script src="https://tistory1.daumcdn.net/tistory/1468360/skin/images/jquery.js"></script>
<link rel="stylesheet" href="https://tistory1.daumcdn.net/tistory/1468360/skin/images/docuK-2.3.css">
<script src="https://tistory3.daumcdn.net/tistory/1468360/skin/images/docuK-prepare-2.3.js" charset="utf-8"></script>
</codeprint><!-- docuK-style -->

<meta charset="utf-8" name="description" content="DATABASE setup of Panda Market by kipid. 판다마켓을 위한 DATABASE 를 구축해 봅시다."/>

<codeprint class="SEE">
# DATABASE setup of Panda Market by kipid

판다마켓을 위한 DATABASE 를 구축해 봅시다.



## PH

<ul>
<li>2024-09-24 : First posting.</li>
</ul>



## TOC



## 기본: npx prisma init

```[.scrollable]
npx prisma init --datasource-provider postgresql
```/

명령을 실행해서 다음과 같은 파일을 얻자.

```[.scrollable]
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
```/

<div class="p">
<code>.env</code> 파일 설정을 다음과 같이 하자.
</div>

```[.scrollable]
DATABASE_URL="postgresql://postgres:[password]@localhost:5432/panda_market_dev?schema=public"
PORT=3000
```/

panda_market_dev DATABASE 가 없으면 알아서 만들어 준다.



## Schema 모음.

Product 관련: <refer class="model-Product"></refer>, <refer class="model-ProductComment"></refer>

User 관련: <refer class="model-User"></refer>

Article 관련: <refer class="model-Article"></refer>, <refer class="model-ArticleComment"></refer>



### Struct 제약조건 모음.

Product 관련: <refer class="struct-Product"></refer>

User 관련: <refer class="struct-User"></refer>

Article 관련: <refer class="struct-Article"></refer>

Comments 관련: <refer class="struct-ProductComment"></refer>, <refer class="struct-ArticleComment"></refer>



## Schema 짜기.

<div id="model-User"><div class="number none">User</div>

```[.scrollable]
model User {
  id              String           @id @default(uuid()) // * Can be used by salt in encryption.
  email           String           @unique
  nickname        String
  password        String
  pwdIter         Int              @default(10000)
  ssnIter         Int              @default(1000)
  articles        Article[]
  articleComments ArticleComment[]
  productComments ProductComment[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}
```/

</div>

<div id="model-Product"><div class="number none">Product</div>

```[.scrollable]
model Product {
  id              String           @id @default(uuid())
  name            String
  description     String
  price           Float
  tags            String[]
  images          String[]
  favoriteCount   Int
  productComments ProductComment[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}
```/

</div>

<div id="model-Article"><div class="number none">Article</div>

```[.scrollable]
model Article {
  id              String           @id @default(uuid())
  title           String
  authorId        String
  author          User             @relation(fields: [authorId], references: [id], onDelete: Restrict)
  content         String
  articleComments ArticleComment[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}
```/

</div>

<div id="model-ProductComment"><div class="number none">ProductComment</div>

```[.scrollable]
model ProductComment {
  id          String   @id @default(uuid())
  content     String
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Restrict)
  commenterId String
  commenter   User     @relation(fields: [commenterId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
```/

</div>

<div id="model-ArticleComment"><div class="number none">ArticleComment</div>

```[.scrollable]
model ArticleComment {
  id          String   @id @default(uuid())
  content     String
  articleId   String
  article     Article  @relation(fields: [articleId], references: [id])
  commenterId String
  commenter   User     @relation(fields: [commenterId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
```/

</div>



### DATA seeding

적당한 mock data 를 가지고 DATA 를 seeding 해주자.

```[.scrollable]
import { PrismaClient } from "@prisma/client";
import data from "./mock.js";
import * as dotenv from 'dotenv';

dotenv.config();
const prisma = new PrismaClient();

async function main() {
	await prisma.product.deleteMany();
	await prisma.product.createMany({
		data,
		skipDuplicates: true,
	})
}

main()
	.then(async () => {
		await prisma.$disconnect();
	})
	.catch(async (e) => {
		console.error(e);
		await prisma.$disconnect();
		process.exit(1);
	});
```/



### prisma superstruct

다음과 같은 제약 조건을 걸어주자.

<div id="struct-Product"><div class="number none">struct-Product</div>

```[.scrollable]
import * as s from 'superstruct';
import isUuid from 'is-uuid';

const Uuid = s.define('Uuid', (value) => isUuid.v4(value));

export const CreateProduct = s.object({
	name: s.size(s.string(), 1, 10),
	description: s.size(s.string(), 10, 100),
	price: s.min(s.number(), 0),
	tags: s.array(s.string()),
	images: s.array(s.string()),
	favoriteCount: s.min(s.integer(), 0),
});

export const PatchProduct = s.object({
	id: Uuid,
	...s.partial(CreateProduct),
});
```/

</div>

<div class="p">
<code>s.set(s.string())</code> 은 어떻게 데이터를 보내는지 모르겠어서 못썼음. 그냥 array 방식으로 묶으면 될줄 알았는데... =ㅇ=;; <code>["가", "나", "다"]</code> 는 Set 가 아니라고 함.
</div>

사용하는 <code>define</code> 은

```[.scrollable]
import * as s from 'superstruct';
import isEmail from 'is-email';
import isUuid from 'is-uuid';

const Uuid = s.define('Uuid', (value) => isUuid.v4(value));
const email = s.define('email', (value) => isEmail(value));
```/

<div id="struct-User"><div class="number none">struct-User</div>

```[.scrollable]
export const CreateUser = s.object({
	email: email,
	nickname: s.size(s.string(), 1, 20),
	password: s.string()
});
export const PatchUser = s.partial(CreateUser);
	// * User id 는 따로 받아야 함.
```/

</div>

<div id="struct-Product"><div class="number none">struct-Product</div>

```[.scrollable]
export const CreateProduct = s.object({
	name: s.size(s.string(), 1, 10),
	description: s.size(s.string(), 10, 100),
	price: s.min(s.number(), 0),
	tags: s.size(s.array(s.string()), 0, 15),
	images: s.size(s.array(s.string()), 1, 2),
	favoriteCount: s.min(s.integer(), 0),
});
export const PatchProduct = s.partial(CreateProduct);
	// * Product id 는 따로 받아야 함.
```/

</div>

<div id="struct-Article"><div class="number none">struct-Article</div>

```[.scrollable]
export const CreateArticle = s.object({
	title: s.size(s.string(), 1, 20),
	authorId: Uuid,
	content: s.size(s.string(), 10, 500),
});
export const PatchArticle = s.partial(CreateArticle);
	// * Article id 는 따로 받아야 함.
```/

</div>

<div id="struct-ProductComment"><div class="number none">struct-ProductComment</div>

```[.scrollable]
export const CreateProductComment = s.object({
	commenterId: Uuid,
	content: s.size(s.string(), 1, 255),
});
	// * Patch 는 위 데이터에 id 추가.
```/

</div>

<div id="struct-ArticleComment"><div class="number none">struct-ArticleComment</div>

```[.scrollable]
export const CreateArticleComment = s.object({
	commenterId: Uuid,
	content: s.size(s.string(), 1, 255),
});
	// * Patch 는 위 데이터에 id 추가.
```/

</div>



## RRA

<ol class="refs">
<li id="ref-panda-market"><a target="_blank" href="https://panda-market-by-kipid.netlify.app/">https://panda-market-by-kipid.netlify.app/</a></li>
<li id="prisma"><a target="_blank" href="https://kipid.tistory.com/entry/prisma-with-PostgreSQL-%EB%A5%BC-%EB%B0%B0%EC%9B%8C%EB%B4%85%EC%8B%9C%EB%8B%A4">kipid's blog :: prisma with PostgreSQL 를 배워봅시다.</a></li>
</ol>
</codeprint><!-- SEE -->

<codeprint id="docuK-script">
<script>
(function(m, $, undefined) {
m.printMode=false;
m.ripplesDisabled=false;
m.recoeveUserId="kipid";
m.recoCats="";
m.wait=1024;
m.delayPad=0;

/**
 *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
 *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
**/
window.disqus_config=function () {
	this.page.identifier="DATABASE-setup-of-Panda-Market-by-kipid"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
	this.page.url=`https://kipid.tistory.com/entry/${this.page.identifier}`; // Replace PAGE_URL with your page's canonical URL variable
};
})(window.k, jQuery);
</script>

<!-- From kipid.tistory CDN -->
<script src="https://tistory3.daumcdn.net/tistory/1468360/skin/images/docuK-postProcess-2.3.js" charset="utf-8"></script>
</codeprint><!-- docuK-script -->
